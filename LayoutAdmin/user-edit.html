<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../assets/css/admin/movies.css" />
    <link rel="stylesheet" href="../assets/css/admin/users-edit.css" />
    <title>NOTFLEX Admin - Ch·ªânh s·ª≠a Ng∆∞·ªùi d√πng</title>

</head>

<body>
    <!-- Header -->
    <header class="header">
        <div class="menu-toggle">‚ò∞</div>
        <a href="dashboard.html" class="logo">NOTFLEX</a>
        <div class="header-title">Ch·ªânh s·ª≠a Ng∆∞·ªùi d√πng</div>
        <div class="user-menu">
            <a href="#">Admin</a>
            <a href="#">ƒêƒÉng xu·∫•t</a>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <nav class="sidebar-menu">
                <div class="menu-title">Qu·∫£n l√Ω n·ªôi dung</div>
                <a href="dashboard.html" class="menu-item">
                    <i class="fa fa-dashboard">üìä</i> Dashboard
                </a>
                <a href="movies.html" class="menu-item">
                    <i class="fa fa-film">üé¨</i> Phim
                </a>
                <a href="genres.html" class="menu-item">
                    <i class="fa fa-tags">üè∑Ô∏è</i> Th·ªÉ lo·∫°i
                </a>

                <div class="menu-title">Qu·∫£n l√Ω ng∆∞·ªùi d√πng</div>
                <a href="users.html" class="menu-item active">
                    <i class="fa fa-users">üë•</i> Users
                </a>
                <a href="roles.html" class="menu-item">
                    <i class="fa fa-lock">üîí</i> Role
                </a>

                <div class="menu-title">H·ªá th·ªëng</div>
                <a href="settings.html" class="menu-item">
                    <i class="fa fa-cog">‚öôÔ∏è</i> C√†i ƒë·∫∑t
                </a>
                <a href="statistics.html" class="menu-item">
                    <i class="fa fa-bar-chart">üìà</i> Th·ªëng k√™
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="page-title">
                <h1>Ch·ªânh s·ª≠a Ng∆∞·ªùi d√πng</h1>
                <a href="users.html" class="btn btn-cancel">Quay l·∫°i danh s√°ch</a>
            </div>

            <div class="user-stats">
                <div class="stat-card">
                    <div class="stat-value" id="roleName">admin</div>
                    <div class="stat-label">Vai tr√≤</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="createdAtDisplay">01/01/2023</div>
                    <div class="stat-label">Ng√†y ƒëƒÉng k√Ω</div>
                </div>
            </div>

            <div class="form-container">
                <div class="form-title">Th√¥ng tin ng∆∞·ªùi d√πng</div>
                <form id="editUserForm">
                    <input type="hidden" id="userId" value="1">
                    <input type="hidden" id="createdAt" value="2023-01-01T00:00:00.000Z">

                    <div class="form-row">
                        <div class="form-group">
                            <label for="username" class="required-field">T√™n ƒëƒÉng nh·∫≠p</label>
                            <input type="text" id="username" class="form-control" value="admin" required>
                            <div id="username-error" class="error-message">Vui l√≤ng nh·∫≠p t√™n ƒëƒÉng nh·∫≠p</div>
                        </div>
                        <div class="form-group">
                            <label for="email" class="required-field">Email</label>
                            <input type="email" id="email" class="form-control" value="admin@example.com" required>
                            <div id="email-error" class="error-message">Vui l√≤ng nh·∫≠p email h·ª£p l·ªá</div>
                        </div>
                    </div>



                    <div class="form-group">
                        <label for="role" class="required-field">Vai tr√≤</label>
                        <select id="role" class="form-control" required>
                            <option value="">Ch·ªçn vai tr√≤</option>
                            <!-- C√°c vai tr√≤ s·∫Ω ƒë∆∞·ª£c ƒëi·ªÅn v√†o ƒë√¢y t·ª´ API -->
                        </select>
                        <div id="role-error" class="error-message">Vui l√≤ng ch·ªçn vai tr√≤</div>
                    </div>

                    <div class="password-section">
                        <div class="password-toggle">
                            <label>
                                <input type="checkbox" id="changePassword">
                                <div>Thay ƒë·ªïi m·∫≠t kh·∫©u</div>
                            </label>
                        </div>

                        <div id="passwordFields">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="password" class="required-field">M·∫≠t kh·∫©u m·ªõi</label>
                                    <input type="password" id="password" class="form-control"
                                        placeholder="Nh·∫≠p m·∫≠t kh·∫©u m·ªõi">
                                    <div id="password-error" class="error-message">M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 8 k√Ω t·ª±
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="confirmPassword" class="required-field">X√°c nh·∫≠n m·∫≠t kh·∫©u</label>
                                    <input type="password" id="confirmPassword" class="form-control"
                                        placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi">
                                    <div id="confirmPassword-error" class="error-message">M·∫≠t kh·∫©u kh√¥ng kh·ªõp</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" id="cancelButton" class="btn btn-cancel">H·ªßy</button>
                        <button type="submit" id="submitButton" class="btn btn-submit">C·∫≠p nh·∫≠t</button>
                    </div>
                </form>
            </div>

            <div class="danger-zone">
                <div class="danger-zone-title">V√πng nguy hi·ªÉm</div>
                <div class="danger-zone-description">
                    X√≥a ng∆∞·ªùi d√πng s·∫Ω x√≥a t·∫•t c·∫£ d·ªØ li·ªáu li√™n quan ƒë·∫øn ng∆∞·ªùi d√πng n√†y. H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.
                </div>
                <button type="button" id="deleteUserButton" class="btn btn-danger">X√≥a ng∆∞·ªùi d√πng n√†y</button>
            </div>
        </main>
    </div>

    <!-- <script src="../assets/js/admin/users-edit.js">

    </script> -->

    <!-- <script>
        document.addEventListener('DOMContentLoaded', function () {
            const userId = document.getElementById('userId').value; // L·∫•y ID ng∆∞·ªùi d√πng t·ª´ input ·∫©n
            const apiUrl = `https://localhost:7186/api/Users/${userId}`; // URL API ƒë·ªÉ l·∫•y th√¥ng tin ng∆∞·ªùi d√πng

            fetch(apiUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Error fetching user: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // ƒêi·ªÅn th√¥ng tin v√†o form
                    document.getElementById('username').value = data.username;
                    document.getElementById('email').value = data.email;
                    document.getElementById('role').value = data.roleId;
                    document.getElementById('createdAtDisplay').innerText = new Date(data.createdAt).toLocaleDateString();
                })
                .catch(error => {
                    console.error('Error fetching user data:', error);
                    alert('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin ng∆∞·ªùi d√πng. Vui l√≤ng th·ª≠ l·∫°i.');
                });
        });

    </script> -->

    <script>
        // L·∫•y id t·ª´ URL
        const params = new URLSearchParams(window.location.search);
        const id = params.get('id');  // L·∫•y ID t·ª´ query string

        // G·ªçi API l·∫•y chi ti·∫øt ng∆∞·ªùi d√πng v√† fill v√†o form
        function fetchDetailUser() {
            const apiUrl = 'https://localhost:7186/api/Users/' + id; // Ki·ªÉm tra l·∫°i URL n√†y

            fetch(apiUrl)
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                    return response.json();
                })
                .then(user => {
                    console.log("D·ªØ li·ªáu ng∆∞·ªùi d√πng:", user);  // Ki·ªÉm tra d·ªØ li·ªáu tr·∫£ v·ªÅ

                    // G√°n d·ªØ li·ªáu v√†o form
                    document.getElementById('username').value = user.username;
                    document.getElementById('email').value = user.email;
                    document.getElementById('roleName').innerHTML = user.roleName;  // G√°n RoleId v√†o form
                    document.getElementById('createdAtDisplay').innerText = new Date(user.createdAt).toLocaleDateString();
                })
                .catch(error => {
                    console.error("Error fetching user:", error);
                    alert('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu ng∆∞·ªùi d√πng. Vui l√≤ng th·ª≠ l·∫°i sau.');
                });
        }

        // G·ªçi h√†m khi trang ƒë∆∞·ª£c t·∫£i
        fetchDetailUser();

        // H√†m editUser
        function editUser() {
            const userId = id;  // L·∫•y ID t·ª´ URL thay v√¨ t·ª´ form
            const username = document.getElementById('username').value;
            const email = document.getElementById('email').value;
            const roleId = document.getElementById('role').value;
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value; // L·∫•y x√°c nh·∫≠n m·∫≠t kh·∫©u
            const submitButton = document.getElementById('submitButton');

            // Ki·ªÉm tra n·∫øu m·∫≠t kh·∫©u thay ƒë·ªïi v√† x√°c nh·∫≠n m·∫≠t kh·∫©u
            let updatedPassword = null;
            if (document.getElementById('changePassword').checked) {
                if (password !== confirmPassword) {
                    alert('M·∫≠t kh·∫©u v√† x√°c nh·∫≠n m·∫≠t kh·∫©u kh√¥ng kh·ªõp.');
                    return;  // D·ª´ng n·∫øu m·∫≠t kh·∫©u kh√¥ng kh·ªõp
                }
                updatedPassword = password;
            }

            const userData = {
                Username: username,
                Email: email,
                Password: updatedPassword,
                RoleId: roleId
            };

            const apiUrl = `https://localhost:7186/api/Users/${userId}`; // Ch·∫Øc ch·∫Øn URL ƒë√∫ng v·ªõi ID ng∆∞·ªùi d√πng

            // Disable n√∫t submit trong khi x·ª≠ l√Ω
            submitButton.disabled = true;
            submitButton.textContent = 'ƒêang x·ª≠ l√Ω...';

            fetch(apiUrl, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(userData)
            })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => {
                            throw new Error(err.message || `L·ªói x·∫£y ra khi c·∫≠p nh·∫≠t ng∆∞·ªùi d√πng. M√£ l·ªói: ${response.status}`);
                        });
                    }
                    return response.json(); // N·∫øu th√†nh c√¥ng, tr·∫£ v·ªÅ d·ªØ li·ªáu JSON
                })
                .then(data => {
                    alert('C·∫≠p nh·∫≠t ng∆∞·ªùi d√πng th√†nh c√¥ng!');
                    window.location.href = 'users.html'; // Chuy·ªÉn h∆∞·ªõng l·∫°i trang danh s√°ch ng∆∞·ªùi d√πng
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert(error.message || 'C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t ng∆∞·ªùi d√πng');
                })
                .finally(() => {
                    submitButton.disabled = false; // K√≠ch ho·∫°t l·∫°i n√∫t submit
                    submitButton.textContent = 'C·∫≠p nh·∫≠t'; // Kh√¥i ph·ª•c l·∫°i t√™n n√∫t
                });
        }

        // G·∫Øn s·ª± ki·ªán cho form
        document.getElementById('editUserForm').addEventListener('submit', function (e) {
            e.preventDefault(); // Ng·ª´ng h√†nh ƒë·ªông m·∫∑c ƒë·ªãnh c·ªßa form
            editUser();  // G·ªçi h√†m ch·ªânh s·ª≠a ng∆∞·ªùi d√πng
        });
    </script>


    <script>
        function deleteUser() {
            const params = new URLSearchParams(window.location.search);
            const id = params.get('id');


            const apiUrl = 'https://localhost:7186/api/Users/' + id; // URL API ƒë·ªÉ x√≥a th·ªÉ lo·∫°i

            if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a th·ªÉ lo·∫°i n√†y?')) {
                fetch(apiUrl, {
                    method: 'DELETE',  // S·ª≠ d·ª•ng DELETE ƒë·ªÉ x√≥a
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        // Ki·ªÉm tra n·∫øu ph·∫£n h·ªìi c√≥ body tr∆∞·ªõc khi g·ªçi .json()
                        if (response.status === 204) {
                            return {};  // Tr·∫£ v·ªÅ m·ªôt ƒë·ªëi t∆∞·ª£ng r·ªóng n·∫øu ph·∫£n h·ªìi 204 (No Content)
                        }
                        return response.json();  // N·∫øu c√≥ d·ªØ li·ªáu, ph√¢n t√≠ch c√∫ ph√°p JSON
                    })
                    .then(data => {
                        alert('Th·ªÉ lo·∫°i ƒë√£ ƒë∆∞·ª£c x√≥a th√†nh c√¥ng!');
                        window.location.href = 'users.html'; // Chuy·ªÉn h∆∞·ªõng l·∫°i trang danh s√°ch th·ªÉ lo·∫°i
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('C√≥ l·ªói x·∫£y ra khi x√≥a th·ªÉ lo·∫°i. Vui l√≤ng th·ª≠ l·∫°i sau.');
                    });

            }
        }

        // G·∫Øn s·ª± ki·ªán cho n√∫t x√≥a
        document.getElementById('deleteUserButton').addEventListener('click', function () {
            deleteUser();
        });

    </script>

    <script>
        // H√†m ƒë·ªÉ l·∫•y c√°c vai tr√≤ t·ª´ API v√† ƒëi·ªÅn v√†o select
        function loadRoles() {
            const apiUrl = 'https://localhost:7186/api/Roles'; // API l·∫•y danh s√°ch vai tr√≤
            const roleSelect = document.getElementById('role');

            // G·ª≠i y√™u c·∫ßu GET ƒë·ªÉ l·∫•y danh s√°ch vai tr√≤
            fetch(apiUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(roles => {
                    // X√≥a c√°c t√πy ch·ªçn c≈© trong select
                    roleSelect.innerHTML = '<option value="">Ch·ªçn vai tr√≤</option>';

                    // Duy·ªát qua danh s√°ch vai tr√≤ v√† th√™m v√†o th·∫ª select
                    roles.forEach(role => {
                        const option = document.createElement('option');
                        option.value = role.id;
                        option.textContent = role.name;
                        roleSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error loading roles:', error);
                    alert('C√≥ l·ªói x·∫£y ra khi t·∫£i danh s√°ch vai tr√≤.');
                });
        }

        // G·ªçi h√†m loadRoles khi trang ƒë∆∞·ª£c t·∫£i
        loadRoles();

    </script>
</body>

</html>