<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../assets/css/admin/movies.css" />
    <link rel="stylesheet" href="../assets/css/admin/genres-edit.css" />
    <title>NOTFLEX Admin - Ch·ªânh s·ª≠a Th·ªÉ lo·∫°i</title>

</head>

<body>
    <!-- Header -->
    <header class="header">
        <div class="menu-toggle">‚ò∞</div>
        <a href="dashboard.html" class="logo">NOTFLEX</a>
        <div class="header-title">Ch·ªânh s·ª≠a Th·ªÉ lo·∫°i</div>
        <div class="user-menu">
            <a href="#">Admin</a>
            <a href="#">ƒêƒÉng xu·∫•t</a>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <nav class="sidebar-menu">
                <div class="menu-title">Qu·∫£n l√Ω n·ªôi dung</div>
                <a href="dashboard.html" class="menu-item">
                    <i class="fa fa-dashboard">üìä</i> Dashboard
                </a>
                <a href="movies.html" class="menu-item">
                    <i class="fa fa-film">üé¨</i> Phim
                </a>
                <a href="genres.html" class="menu-item active">
                    <i class="fa fa-tags">üè∑Ô∏è</i> Th·ªÉ lo·∫°i
                </a>

                <div class="menu-title">Qu·∫£n l√Ω ng∆∞·ªùi d√πng</div>
                <a href="users.html" class="menu-item">
                    <i class="fa fa-users">üë•</i> Users
                </a>
                <a href="roles.html" class="menu-item">
                    <i class="fa fa-lock">üîí</i> Role
                </a>

                <div class="menu-title">H·ªá th·ªëng</div>
                <a href="settings.html" class="menu-item">
                    <i class="fa fa-cog">‚öôÔ∏è</i> C√†i ƒë·∫∑t
                </a>
                <a href="statistics.html" class="menu-item">
                    <i class="fa fa-bar-chart">üìà</i> Th·ªëng k√™
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="page-title">
                <h1>Ch·ªânh s·ª≠a Th·ªÉ lo·∫°i</h1>
                <a href="genres.html" class="btn btn-cancel">Quay l·∫°i danh s√°ch</a>
            </div>

            <div class="genre-stats">
                <div class="stat-card">
                    <div class="stat-value">1</div>
                    <div class="stat-label">ID</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="movieCount">245</div>
                    <div class="stat-label">S·ªë phim</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="createdAtDisplay">01/01/2023</div>
                    <div class="stat-label">Ng√†y t·∫°o</div>
                </div>
            </div>

            <div class="form-container">
                <div class="form-title">Th√¥ng tin th·ªÉ lo·∫°i</div>
                <form id="editGenreForm">
                    <input type="hidden" id="genreId" value="1">
                    <input type="hidden" id="createdAt" value="2023-01-01T00:00:00.000Z">

                    <div class="form-group">
                        <label for="name" class="required-field">T√™n th·ªÉ lo·∫°i</label>
                        <input type="text" id="name" class="form-control" value="H√†nh ƒë·ªông" required>
                        <div id="name-error" class="error-message">Vui l√≤ng nh·∫≠p t√™n th·ªÉ lo·∫°i</div>
                    </div>

                    <div class="form-group">
                        <label for="description" class="required-field">M√¥ t·∫£</label>
                        <textarea id="description" class="form-control" rows="4"
                            required>Phim c√≥ nhi·ªÅu c·∫£nh h√†nh ƒë·ªông, ƒë√°nh ƒë·∫•m, r∆∞·ª£t ƒëu·ªïi</textarea>
                        <div id="description-error" class="error-message">Vui l√≤ng nh·∫≠p m√¥ t·∫£ th·ªÉ lo·∫°i</div>
                    </div>

                    <div class="form-actions">
                        <button type="button" id="cancelButton" class="btn btn-cancel">H·ªßy</button>
                        <button type="submit" id="submitButton" class="btn btn-submit">C·∫≠p nh·∫≠t th·ªÉ lo·∫°i</button>
                    </div>
                </form>
            </div>

            <div class="danger-zone">
                <div class="danger-zone-title">V√πng nguy hi·ªÉm</div>
                <div class="danger-zone-description">
                    X√≥a th·ªÉ lo·∫°i s·∫Ω ·∫£nh h∆∞·ªüng ƒë·∫øn t·∫•t c·∫£ phim thu·ªôc th·ªÉ lo·∫°i n√†y. H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.
                </div>
                <button type="button" id="deleteGenreButton" class="btn btn-danger">X√≥a th·ªÉ lo·∫°i n√†y</button>
            </div>
        </main>
    </div>

    <!-- <script src="../assets/js/admin/genres-edit.js">

    </script> -->
    <script>
        function editGenre() {
            const genreId = document.getElementById('genreId').value; // L·∫•y ID th·ªÉ lo·∫°i t·ª´ m·ªôt input ·∫©n
            const apiUrl = `https://localhost:7186/api/Genres/${genreId}`; // C·∫≠p nh·∫≠t URL ƒë·ªÉ bao g·ªìm genreId
            const nameInput = document.getElementById('name');
            const descriptionInput = document.getElementById('description');
            const submitButton = document.getElementById('submitButton');

            // T·∫°o payload t·ª´ form
            const genreData = {
                name: nameInput.value.trim(),
                description: descriptionInput.value.trim(),
            };

            // Disable n√∫t submit trong khi x·ª≠ l√Ω
            submitButton.disabled = true;
            submitButton.textContent = 'ƒêang x·ª≠ l√Ω...';

            fetch(apiUrl, {
                method: 'PUT',  // S·ª≠ d·ª•ng PUT ƒë·ªÉ c·∫≠p nh·∫≠t
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(genreData)  // Chuy·ªÉn ƒë·ªïi genreData th√†nh JSON
            })
                .then(response => {
                    if (!response.ok) {
                        // N·∫øu ph·∫£n h·ªìi kh√¥ng OK, tr·∫£ v·ªÅ l·ªói
                        return response.json().then(err => {
                            throw new Error(err.message || 'C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t th·ªÉ lo·∫°i');
                        });
                    }
                    return response.json(); // N·∫øu th√†nh c√¥ng, chuy·ªÉn ph·∫£n h·ªìi th√†nh JSON
                })
                .then(data => {
                    alert('C·∫≠p nh·∫≠t th·ªÉ lo·∫°i th√†nh c√¥ng!');
                    window.location.href = 'genres.html'; // Chuy·ªÉn h∆∞·ªõng sau khi th√†nh c√¥ng
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert(error.message || 'C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t th·ªÉ lo·∫°i');
                })
                .finally(() => {
                    submitButton.disabled = false;  // K√≠ch ho·∫°t l·∫°i n√∫t submit
                    submitButton.textContent = 'C·∫≠p nh·∫≠t th·ªÉ lo·∫°i';  // Kh√¥i ph·ª•c l·∫°i t√™n n√∫t
                });
        }

        // G·∫Øn s·ª± ki·ªán cho form
        document.getElementById('editGenreForm').addEventListener('submit', function (e) {
            e.preventDefault();
            editGenre();  // G·ªçi h√†m ch·ªânh s·ª≠a th·ªÉ lo·∫°i khi form ƒë∆∞·ª£c g·ª≠i
        });

        // X·ª≠ l√Ω n√∫t h·ªßy
        document.getElementById('cancelButton').addEventListener('click', function () {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën h·ªßy thao t√°c n√†y?')) {
                window.location.href = 'genres.html'; // Quay l·∫°i danh s√°ch th·ªÉ lo·∫°i
            }
        });

    </script>

    <script>
        // L·∫•y id t·ª´ URL
        const params = new URLSearchParams(window.location.search);
        const id = params.get('id');  // L·∫•y ID t·ª´ query string

        // G·ªçi API l·∫•y chi ti·∫øt th·ªÉ lo·∫°i v√† fill v√†o form
        function fetchDetailGenre() {
            const apiUrl = 'https://localhost:7186/api/Genres/' + id; // Ki·ªÉm tra l·∫°i URL n√†y


            fetch(apiUrl)
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                    return response.json();
                })
                .then(genre => {
                    console.log("D·ªØ li·ªáu th·ªÉ lo·∫°i:", genre);  // Ki·ªÉm tra d·ªØ li·ªáu tr·∫£ v·ªÅ

                    // G√°n d·ªØ li·ªáu v√†o form
                    const statValues = document.getElementsByClassName('stat-value');
                    console.log('createdAt', genre.createdAt);

                    // Hi·ªÉn th·ªã ng√†y t·∫°o th·ªÉ lo·∫°i
                    document.getElementById('createdAtDisplay').innerHTML = genre.createdAt;

                    // G√°n ID th·ªÉ lo·∫°i
                    if (statValues.length > 0) statValues[0].innerText = genre.id;

                    // G√°n th√¥ng tin v√†o c√°c input trong form
                    document.getElementById('genreId').value = genre.id;
                    document.getElementById('createdAt').value = genre.createdAt;
                    document.getElementById('name').value = genre.name;
                    document.getElementById('description').value = genre.description;
                    document.getElementById('movieCount').innerText = genre.movieCount;

                    // Hi·ªÉn th·ªã ng√†y t·∫°o
                    document.getElementById('createdAtDisplay').innerText = new Date(genre.createdAt).toLocaleDateString();




                })
                .catch(error => {
                    console.error("Error fetching genre:", error);
                    alert('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu th·ªÉ lo·∫°i. Vui l√≤ng th·ª≠ l·∫°i sau.');
                });
        }

        // G·ªçi h√†m khi trang ƒë∆∞·ª£c t·∫£i
        fetchDetailGenre();
    </script>

    <script>
        function deleteGenre() {
            const genreId = document.getElementById('genreId').value; // L·∫•y ID th·ªÉ lo·∫°i t·ª´ input ·∫©n
            const apiUrl = 'https://localhost:7186/api/Genres/' + genreId; // URL API ƒë·ªÉ x√≥a th·ªÉ lo·∫°i

            if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a th·ªÉ lo·∫°i n√†y?')) {
                fetch(apiUrl, {
                    method: 'DELETE',  // S·ª≠ d·ª•ng DELETE ƒë·ªÉ x√≥a
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        // Ki·ªÉm tra n·∫øu ph·∫£n h·ªìi c√≥ body tr∆∞·ªõc khi g·ªçi .json()
                        if (response.status === 204) {
                            return {};  // Tr·∫£ v·ªÅ m·ªôt ƒë·ªëi t∆∞·ª£ng r·ªóng n·∫øu ph·∫£n h·ªìi 204 (No Content)
                        }
                        return response.json();  // N·∫øu c√≥ d·ªØ li·ªáu, ph√¢n t√≠ch c√∫ ph√°p JSON
                    })
                    .then(data => {
                        alert('Th·ªÉ lo·∫°i ƒë√£ ƒë∆∞·ª£c x√≥a th√†nh c√¥ng!');
                        window.location.href = 'genres.html'; // Chuy·ªÉn h∆∞·ªõng l·∫°i trang danh s√°ch th·ªÉ lo·∫°i
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('C√≥ l·ªói x·∫£y ra khi x√≥a th·ªÉ lo·∫°i. Vui l√≤ng th·ª≠ l·∫°i sau.');
                    });

            }
        }

        // G·∫Øn s·ª± ki·ªán cho n√∫t x√≥a
        document.getElementById('deleteGenreButton').addEventListener('click', function () {
            deleteGenre();
        });

    </script>



</body>

</html>